<html>
    <head>
        <title>Shimmer</title>
        <link rel="stylesheet" href="/style.css">
        <script src="/apiRequest.js" type="application/javascript"></script>
        <style>
            div#target-pane {
                padding-top:29px;
            }
            table, th, td {
                border: 1px solid #666;
                border-collapse: collapse;
            }
            table {
                width:100%;
            }
            table td, table th {
                padding: 5px;
                text-align: left;
                background: white;
            }
            table tr:nth-child(even) td {
                background: #ddd;
            }
            table th.notes {
                padding-right: 200px;
            }
        </style>
    </head>
    <body>
        <div id="menu">
            <div class="menu_logo">
                <div class="menu_title">Sh<span style="color: red;">immer</span></div>
            </div>
            <div class="menu_item">
                <div class="menu_title">File</div>
                <div class="menu_list">
                    <div class="menu_list_spacer"></div>
                    <div class="menu_list_item"><a href="/view/images">View Images</a></div>
                    <div class="menu_list_spacer"></div>
                </div>
            </div>
            <div class="menu_item">
                <div class="menu_title">Edit</div>
                <div class="menu_list">
                    <div class="menu_list_spacer"></div>
                    <div id="button_0" class="menu_list_item">Merge Targets</div>
                    <div class="menu_list_spacer"></div>
                </div>
            </div>
        </div>
        <div id="target-pane"></div>
        <div id="footer" class="hidden"></div>
        <script type="application/javascript" >
            /**
             * Activate UI elements for merging targets
             */
            var activateTargetMerge = function () {
                var footer = document.getElementById("footer");
                footer.classList.remove("hidden");

                var buttonWrapper = document.createElement("div");
                buttonWrapper.classList.add("footer_item");
                buttonWrapper.classList.add("footer_buttons");

                // Create Cancel Button
                var cancelButton = document.createElement("button");
                cancelButton.appendChild(document.createTextNode("Cancel"));
                buttonWrapper.appendChild(cancelButton);

                // Create Submit Button
                var submitButton = document.createElement("button");
                submitButton.appendChild(document.createTextNode("Submit"));
                buttonWrapper.appendChild(submitButton);

                footer.appendChild(buttonWrapper);

                // Add checkboxes for merging targets
                var table = document.getElementById("target-table");

                var cell = document.createElement('th');
                cell.appendChild(document.createTextNode("Merge?"));
                table.rows[0].appendChild(cell);

                for (var i = 1, row; row = table.rows[i]; i++) {
                    var cell = document.createElement('td');
                    //<input type="checkbox" name="cb'+iter+'"/>
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                }
                // Set up button click functions
                cancelButton.onclick = function () {
                    footer.removeChild(buttonWrapper);
                    footer.classList.add("hidden");
                };

                submitButton.onclick = function () {
                    var mergeList = [];
                    for (var i = 1, row; row = table.rows[i]; i++) {
                        var lastIdx = row.cells.length - 1;
                        var checkbox = row.cells[lastIdx].firstChild;
                        if(checkbox.checked) {
                            mergeList.push(row.getAttribute("targetid"));
                        }
                    }
                    apiRequest("POST", "/target/merge", function (res) {
                        location.reload();
                    }, JSON.stringify(mergeList));
                };
            };

            document.addEventListener("DOMContentLoaded", function(){
                var mergeTargetButton = document.getElementById("button_0");
                mergeTargetButton.onclick = activateTargetMerge;

                // Load targets
                apiRequest("GET", "/target/all", function (raw) {
                    var targetPane = document.getElementById("target-pane");
                    var table = document.createElement('table');
                    table.id = "target-table";
                    var row = document.createElement('tr');
                    var headers = ["Thumbnail", "ID", "Type", "Shape", "Character", "Shape Color", "Character Color", "Orientation"]
                    headers.forEach(function (name) {
                        var cell = document.createElement('th');
                        cell.appendChild(document.createTextNode(name));
                        row.appendChild(cell);
                    });

                    var cell = document.createElement('th');
                    cell.appendChild(document.createTextNode("Notes"));
                    cell.classList.add("notes");
                    row.appendChild(cell);

                    table.appendChild(row);

                    for(var i = 0; i < raw.length; i++) {
                        row = document.createElement('tr');
                        var tgt = raw[i];
                        if(!tgt.target_id) // Skip lazy deleted targets
                            continue;
                        row.setAttribute("targetid", tgt.target_id);

                        // Insert thumbnail
                        var cell = document.createElement('td');
                        var img = new Image();
                        img.src = "/target/" + tgt.target_id + "/thumb.jpg";
                        cell.appendChild(img);
                        row.appendChild(cell);

                        // Insert other fields
                        [
                            tgt.target_id, tgt.target_type, tgt.shape, tgt.letter,
                            tgt.shape_color, tgt.letter_color,
                            tgt.orientation, tgt.notes
                        ].forEach(function (name) {
                            var cell = document.createElement('td');
                            cell.appendChild(document.createTextNode(name));
                            row.appendChild(cell);
                        });
                        table.appendChild(row);
                    }

                    targetPane.appendChild(table);
                });
            });
        </script>
    </body>
</html>